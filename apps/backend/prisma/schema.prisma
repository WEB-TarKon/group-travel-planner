generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  login     String  @unique

  firstName    String
  lastName     String

  phone        String?  @unique
  telegramUsername String? @unique

  name         String?
  passwordHash String
  createdAt    DateTime @default(now())

  tripsOrganized Trip[]        @relation("OrganizerTrips")
  tripMembers    TripMember[]
  waypoints      Waypoint[]    @relation("UserWaypoints")
  joinRequests   JoinRequest[]
  bankLink       String?

  payments      Payment[]
  notifications Notification[]

  tripMemories     TripMemory[]
  tripMemoriesDone TripMemoryDone[]

  telegramChatId   String? @unique
  telegramLinkCode String? @unique

  foodChoices FoodChoice[]

  passwordResetTokens PasswordResetToken[]
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  userId String
  user   User @relation(fields: [userId], references: [id])

  @@index([userId, expiresAt])
}

model Trip {
  id        String     @id @default(cuid())
  title     String
  isPublic  Boolean    @default(false)
  status    TripStatus @default(ACTIVE)
  createdAt DateTime   @default(now())

  organizerId String
  organizer   User   @relation("OrganizerTrips", fields: [organizerId], references: [id])

  members      TripMember[]
  waypoints    Waypoint[]
  joinRequests JoinRequest[]

  finance  TripFinance?
  payments Payment[]

  memories     TripMemory[]
  memoriesDone TripMemoryDone[]

  foodItems   FoodItem[]
  foodChoices FoodChoice[]
}

model TripMember {
  id        String       @id @default(cuid())
  role      MemberRole   @default(PARTICIPANT)
  status    MemberStatus @default(PENDING)
  createdAt DateTime     @default(now())

  tripId String
  userId String

  trip Trip @relation(fields: [tripId], references: [id])
  user User @relation(fields: [userId], references: [id])

  finishedMemories Boolean @default(false)

  @@unique([tripId, userId])
}

model Waypoint {
  id        String   @id @default(cuid())
  order     Int
  title     String?
  lat       Float
  lng       Float
  createdAt DateTime @default(now())

  tripId String
  trip   Trip   @relation(fields: [tripId], references: [id])

  createdById String?
  createdBy   User?   @relation("UserWaypoints", fields: [createdById], references: [id])

  @@index([tripId, order])
}

enum TripStatus {
  DRAFT
  PLANNED
  ACTIVE
  FINISHED
  CANCELLED
}

enum MemberRole {
  ORGANIZER
  PARTICIPANT
}

enum MemberStatus {
  PENDING
  ACTIVE
  REMOVED
}

model JoinRequest {
  id        String            @id @default(cuid())
  status    JoinRequestStatus @default(PENDING)
  createdAt DateTime          @default(now())

  tripId String
  trip   Trip   @relation(fields: [tripId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  @@unique([tripId, userId])
  @@index([tripId, status])
}

enum JoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model TripFinance {
  id     String @id @default(cuid())
  tripId String @unique
  trip   Trip   @relation(fields: [tripId], references: [id])

  baseAmountUah Int
  depositUah    Int @default(0)

  payDeadlineUser      DateTime @default(now())
  payDeadlineOrganizer DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Payment {
  id     String @id @default(cuid())
  tripId String
  trip   Trip   @relation(fields: [tripId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  amountUah Int
  status    PaymentStatus @default(PENDING) // PENDING -> REPORTED -> CONFIRMED / REJECTED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  removedAt  DateTime?
  reportedAt DateTime?

  proofUrl     String? // /uploads/.... або S3 URL
  proofName    String?
  proofMime    String?
  note         String?
  rejectReason String?

  @@unique([tripId, userId])
  @@index([tripId, status])
}

enum PaymentStatus {
  PENDING
  REPORTED
  CONFIRMED
  REJECTED
}

enum NotificationType {
  DEADLINE_CHANGED
  DEADLINE_REMINDER_ORGANIZER
  MEMBER_EXCLUDED

  JOIN_REQUEST_RECEIVED
  JOIN_REQUEST_APPROVED
  JOIN_REQUEST_REJECTED

  PAYMENT_REPORTED
  PAYMENT_CONFIRMED
  PAYMENT_REJECTED
}

model Notification {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  type    NotificationType @default(DEADLINE_CHANGED)
  title   String           @default("")
  message String           @default("")

  tripId String?
  isRead Boolean @default(false)

  createdAt DateTime  @default(now())
  readAt    DateTime?

  @@index([userId, isRead])
}

enum MemoryType {
  TEXT
  PHOTO
  VIDEO
  AUDIO
}

model TripMemory {
  id        String     @id @default(cuid())
  tripId    String
  userId    String
  type      MemoryType
  text      String?
  fileUrl   String?
  fileName  String?
  fileMime  String?
  createdAt DateTime   @default(now())

  trip Trip @relation(fields: [tripId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@index([tripId])
}

model TripMemoryDone {
  id     String   @id @default(cuid())
  tripId String
  userId String
  doneAt DateTime @default(now())

  trip Trip @relation(fields: [tripId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([tripId, userId])
}

model FoodItem {
  id     String @id @default(cuid())
  tripId String
  trip   Trip   @relation(fields: [tripId], references: [id], onDelete: Cascade)

  title    String
  priceUah Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  choices FoodChoice[]

  @@index([tripId])
}

model FoodChoice {
  id     String @id @default(cuid())
  tripId String
  trip   Trip   @relation(fields: [tripId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  itemId String
  item   FoodItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([tripId, userId, itemId])
  @@index([tripId, userId])
}
